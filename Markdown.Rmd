---
title: "Markdown Report"
author: "Casper M. Lyngbye, Thea A. Dencker, Jonas N. Rasmussen, Lucy. D. Borhi"
date: "2025-04-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading libraries

```{r Libraries, warning=FALSE, error=FALSE, message=FALSE}
library(ampvis2)
library(leaflet)
library(readxl)
library(tidyverse)
library(ggthemes)
library(patchwork)
```


## Creating maps
For each sample taken, pictures were taken of the sampling location. This was done in order to be able to extract metadata, which could be used for creating the maps. This didn't work out as planned, as some of the GPS-coordinates proved to be inaccurate;

```{r Picture_Map, warning=FALSE, error=FALSE, message=FALSE}
library(exifr)
pictures = list.files(path = "Pictures/", pattern = "*.HEIC", full.names = TRUE)

dat <- read_exif(pictures)

dat.gps = select(dat,
                 SourceFile, DateTimeOriginal,
                 GPSLongitude, GPSLatitude,
                 GPSTimeStamp)
leaflet(dat.gps) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addMarkers(~ GPSLongitude, ~ GPSLatitude)  

```

As shown above, while some GPS-coordinates are correct, others are not. Therefore, the GAIA GPS app was also used in order to obtain coordinates for the making of maps. The coordinates provided by GAIA proved to be more consistent, as shown below. However, only the sample locations were noted, as the 3 subsamples were excluded:


```{r Janneke_Gps_Map, warning=FALSE, error=FALSE, message=FALSE}
datgps = read_excel("Data/Sample_location.xlsx")

leaflet(datgps,
        options = leafletOptions(zoomControl = FALSE)) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircleMarkers(lng = ~ `long _x`, 
                   lat = ~ lat_y,
                   radius = 3,
                   color = "dodgerblue", 
                   label = ~Location,
                   labelOptions = labelOptions(noHide = TRUE,
                                               textOnly = TRUE,
                                               direction = "top",
                                style = list(
                                  "color" = "white",
                                  "font-family" = "serif",
                                  "font-style" = "bold",
                                  "box-shadow" = "3px 3px rgba(0,0,0,0)",
                                  "font-size" = "14px",
                                  "border-color" = "rgba(0,0,0,0)"
                                )))%>%
  addMiniMap(position = "topright",
             height = 250,
             width = 200,
             zoomLevelOffset = -6.69,
             aimingRectOptions = list(color = "red", weight = 1, clickable = FALSE))%>%
  addScaleBar(position = "topleft")
```



## Data from laboratory
The number of dead and pupated waxworms during the experiments was noted. There were three different rebaiting days, and therefore three sheets - one for each baiting period. These are bound together and mutated, in order to transform the sample and subsample into a factor, rather than an integer.

```{r LarvaeData}
df =  rbind(read_excel("Data/Data.xlsx", sheet = 1),
            read_excel("Data/Data.xlsx", sheet = 2),
            read_excel("Data/Data.xlsx", sheet = 3)) %>%
      mutate(sample    = as.factor(sample),
             subsample = as.factor(subsample))
df
```


## Positive Negative Plot of samples
After confirming that EPNs were present, while examining the samples under the microscope, their occurence was noted in a separate column. This was done in order to survey which of the samples were positive for EPNs. This could be used and visualized as shown below:

```{r PosNegPlot, warning=FALSE, error=FALSE}
grid_forest = df %>%
  filter(location == "Forest")%>%
  ggplot(aes(sample,subsample))+
  geom_tile(aes(fill = infected, width = 1, height = 0.4), alpha  = .8, color = "black")+
  scale_fill_manual(values = c("#eb346e", "#89eb34"),
                    name = "")+
  labs(x = "Sample",
       y = "Subsample")+
  facet_wrap(~date)+
  theme_classic()

grid_beet = df %>%
  filter(location == "Beet Field")%>%
  ggplot(aes(sample,subsample))+
  geom_tile(aes(fill = infected, width = 1, height = 0.4), alpha  = .8, color = "black")+
  scale_fill_manual(values = c("#eb346e", "#89eb34"),
                    name = "")+
  labs(y = "Subsample",
       x = "Sample")+
  facet_wrap(~date)+
  theme_classic()


PosNegPlot = (grid_forest/grid_beet) + 
              plot_annotation(tag_levels = "A")+
              plot_layout(guides = "collect") & theme(legend.position = 'bottom',
                                          legend.text=element_text(size=7),
                                          legend.key.size = unit(.45, "cm"))
PosNegPlot
```

```{r PosNegPlotSave, include = FALSE}
ggsave(plot = PosNegPlot,
       filename = "PosNegPlot.tiff", 
       path = "Plots/",
       width =5,
       height = 5,
       units = "in")
```

## Mean pupaeted and died

```{r}
df %>%
  group_by(location, date)%>%
  summarise(meanDead = mean(dead.worms),
            sdDead = sd(dead.worms),
            .groups = "drop") %>%
  ggplot(aes(date, meanDead, color = location))+
  geom_errorbar(aes(ymin = meanDead-sdDead,
                    ymax = meanDead+sdDead),
                width = .1,
                position = position_dodge(0.5))+
  geom_point(position = position_dodge(0.5))+
  labs(
    y= "Mean of dead larvae",
    x= NULL)+
  theme_classic()
```


## Session Info
Session info for data processing used.

```{r}
sessionInfo()
```

